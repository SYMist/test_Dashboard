# 대시보드 PRD (Product Requirements Document)

## 목적과 범위
- 상품별 문의 현황과 주문 현황을 한 화면에서 빠르게 비교·탐색하고, 언어/문의 유형/예약 상태 등의 다차원 분석을 지원한다.
- 실시간(또는 준실시간) 데이터 반영까지는 범위 외. 1일 1회 또는 온디맨드 재생성 기준.

### 전역 필터 원칙
- 페이지 최상단의 “기간(시작/종료)”과 “상품 검색(이름/코드)”은 전역 필터
- 전역 필터는 모든 차트/카드/툴팁의 데이터 집계에 공통으로 적용
  - 적용 대상: 상단 트렌드, 상품 기반 스택 바/주문 오버레이, 상품 툴팁(문의/주문), 예약 기반 모든 차트, 예약코드 차트, ‘주문 대비 문의 비율’ 카드 등
  - 필터 변경 시 모든 시각화가 일관되게 재계산/리렌더링

## 주요 사용자 액션(시나리오)
- 상단 “일자 별 문의 수” 트렌드 차트
  - 단위 탭(일/월/분기/반기/연)으로 집계 그라뉼러리티 전환
  - 선택된 탭 값에 따라 등록된 모든 문의 조회

- “상품 기반 분석” 차트
  - 차원 전환 탭: ‘문의 유형’/‘언어’ 기준으로 상품 별로 등록된 문의 스택 바 확인
  - ‘주문량 보기’ 토글: 각 상품 행에 주문량 보조 막대(동일 축 스케일) 오버레이
  - Y축 상품명 라벨 클릭: 툴팁 오버레이 노출
    - 툴팁 제목 우측에 “문의 수/주문 수 = {문의}/{주문} {백분율}” 표기
    - 툴팁 내부에 해당 상품으로 필터된 “일자 별 문의 수/주문 수” 그룹형 막대 그래프 (단위 탭 동일)
    - 툴팁 외부 클릭으로 닫기, 라벨 위치 기준으로 위쪽 우선 배치(뷰포트 클램프)
  - 스택 바(세그먼트) 클릭: 상세 패널(파이·리스트) 툴팁 오버레이 노출
    - 현재 차원(문의 유형/언어)에 따라, 선택한 상품의 분포를 파이 차트로 표시
      - 예: ‘문의 유형’ 모드에서 특정 상품의 ‘상품 문의’ 세그먼트를 클릭 → 해당 상품의 언어 분포 파이
      - 예: ‘언어’ 모드에서 특정 상품의 ‘ko’ 세그먼트를 클릭 → 해당 상품의 문의 유형 분포 파이
    - 함께 제공: 동일 조건(상품·차원·언어/유형)의 '문의 내용(ticket_sumamry)' 노출
    - 패널 닫기 버튼 제공, 외부 클릭 시 닫힘

- “예약 기반 분석” 차트
  - 예약 상태 전체 분포 및 상태×문의유형/언어 교차 집계 바 차트 확인
  - 예약 상태별/상품별 분포 전환
  - 예약코드별 문의 수 막대 차트(내림차순)
  - 상품 별 주문 대비 문의 비율 카드: 상품별로 (문의 합계/주문 수량 합계)를 백분율로 산출해 정렬 리스트로 제공
  - 언어별 문의 유형 분포 카드: 언어별 카드에 해당 언어 내 문의 유형 Top N 및 비율(%)을 요약해 제공
  - 예약코드 별 문의 수: 동일 예약코드로 등록된 문의 건수를 수평 막대 차트로 표시(내림차순)
---

## 데이터 매핑(더미 → 실제)

### user_inquiry (user_inquiry_dummy_database.csv)
- 상품 코드: id=41989966629273인 custom_fields의 값에서 마지막 5자리 수 추출 / 유저가 입력한 spot 코드
- 상품 명: id=41989966629273인 custom_fields의 스팟 코드로 spot_translation에서 language=‘ko’인 spot_name 매핑
- 언어: id=41989966629273인 custom_fields의 locale (예: zh-TW)
- 카테고리: id=41988850452761인 custom_fields
- 문의 유형: id=41988618714009인 custom_fields
- 문의 내용: ticket_summary
- 요청 ID: id
- 예약코드: id=41989351980441인 custom_fields
- 예약 상태: 데이터베이스 내 없음 (보완 필요)
- createdAt: created_at

### product_order (product_order_dummy_database.csv)
- 주문 ID: reserve.code
- 상품 코드: id=41989966629273인 custom_fields의 값에서 마지막 5자리 수 추출
- 상품 명: id=41989966629273인 custom_fields의 스팟 코드로 spot_translation에서 language=‘ko’인 spot_name 매핑
- 주문 일시: reserve.created_at
- 수량: reserve.order_number
- (주문 상태/결제 수단/주문 금액: 미사용 → 수집/전송 제외)

---

## 요구사항

### 프론트엔드
- 상단 트렌드 카드
  - 단위 탭(일/월/분기/반기/연) 전환 시 재집계 및 리렌더
  - 최상단 전역 필터(기간/상품 검색) 변경 시 트렌드도 함께 필터링되어 재계산
  - 정렬 UI는 이 카드에는 제공하지 않음(각 차트별로 제공)
  - 호버 툴팁: 가까운 버킷의 날짜/건수 표시
  - 최근 문의 표(트렌드 하단)
    - 컬럼: Created_at, 요청 ID, 예약코드, 상품 코드, 상품명, 언어, 문의 유형, 문의 내용
    - 페이징: 클라이언트 페이징(10행/페이지), 페이지네이션 UI(이전/다음/페이지 번호)
    - 검색/정렬: 검색(상품명/코드/본문), 정렬(최신순/오래된순; created_at 기준)
    - 링크화: 요청 ID/예약코드는 링크로 표현(초기에는 placeholder URL)
- 상품 기반 분석 차트
  - 차원 전환 탭(문의 유형/언어)으로 상품×차원 분해 스택 바 렌더
  - ‘주문량 보기’ 토글 시 주문 보조 막대 오버레이 (동일 X 스케일)
  - 정렬 선택: ‘문의 많은 순’/‘문의 적은 순’ (기본: ‘문의 많은 순’) — 상품 총 문의량 기준 Y축 정렬
  - Y축 라벨 클릭 → 툴팁 오버레이
    - 제목 옆 통계: “· 문의 수/주문 수 = {문의}/{주문} {백분율}”
    - 단위 탭 포함한 그룹형 막대 그래프(문의/주문 병렬)
    - 외부 클릭 닫기, 라벨 기준 상하 배치, 뷰포트 클램프 처리
  - 전역 필터 적용: 기간/상품 검색 변경 시 본 차트와 주문 오버레이, 툴팁 내 시계열 모두 동일 조건으로 제한
- 예약 기반 분석 차트
  - 예약 상태 전체 분포/상태×문의유형/언어 교차 집계 바 차트 제공
  - 예약코드별 문의 수 막대 차트(내림차순)
  - 전역 필터 적용: 기간/상품 검색 변경 시 예약 관련 차트도 동일하게 필터링(예약 상태 데이터가 있을 경우)
  - 정렬 선택: ‘문의 많은 순’/‘문의 적은 순’ (기본: ‘문의 많은 순’) — 상태 목록/예약코드 목록 정렬
  - 상품 별 주문 대비 문의 비율 카드
    - 상품명 기준 정렬 리스트(문의/주문 비율 %), 항목에 문의/주문 원시값 병기
    - 전역 필터 반영(기간/상품), 호버 시 상세(예: {문의}/{주문})
  - 언어별 문의 유형 분포 카드
    - 언어별 카드 리스트, 각 카드에 해당 언어 내 문의 유형 Top N과 비율(%) 표시
    - 전역 필터 반영, Top N 개수는 구성 가능(기본 3~5)
  - 예약코드 별 문의 수 차트
    - 수평 막대(내림차순), 전역 필터 반영, 호버 시 예약코드/건수 노출
    - 정렬 선택: ‘문의 많은 순’/‘문의 적은 순’ (기본: ‘문의 많은 순’)
- 성능
  - ≥ 수천 행 CSV/응답에서도 부드럽게 렌더(가상 스크롤 또는 DOM 최소화)
  - 필요 시 Web Worker로 전처리(집계) 분리 고려
- 오류 처리/가드
  - 필수 컬럼 미존재/빈 데이터 시 안내 문구(“데이터 없음”) 표기
  - 잘못된 로케일/코드 값 정규화 실패 시 안전한 폴백

#### 차트별 데이터(프론트엔드 소비 기준)
- 상단 “일자 별 문의 수”(트렌드)
  - 데이터: user_inquiry.created_at 기준 문의 건수 집계
  - 집계 단위: 일/월/분기/반기/연 (기간 선택 시 해당 범위로 제한)
  - 전역 필터: 최상단 기간/상품 검색을 공통 적용
  - 하단 표 데이터: user_inquiry에서 id, custom_fields(예약코드), product_code, spot_name(ko), locale, 문의 유형, ticket_summary, created_at

- 상품 기반 분석(메인 스택 바)
  - 데이터(문의): user_inquiry
    - 그룹: product_code × (문의 유형 id=41988618714009) 또는 product_code × (locale; id=41989966629273)
    - 상품명 표기: product_code → spot_translation(language='ko').spot_name 매핑
  - 보조 데이터(주문 오버레이): product_order
    - 그룹: product_code 별 주문 “수량” 합계 (reserve.order_number 합)
    - 동일 X축 스케일에서 보조 막대(회색)로 표기
  - 전역 필터: 기간/상품 검색이 집계에 반영

- 상품 툴팁(상품명 클릭 시)
  - 제목 우측 통계: “문의 수/주문 수 = Σ(해당 상품 문의)/Σ(해당 상품 주문수량) {백분율}”
    - 문의 합계: user_inquiry(해당 product_code 전체)
    - 주문 합계: product_order.reserve.order_number 합계
  - 내부 차트(그룹형 막대)
    - 문의: user_inquiry.created_at을 선택 단위(일/월/분기/반기/연)로 집계
    - 주문: product_order.reserve.created_at을 동일 단위로 집계, 각 버킷에서 주문 “수량”(order_number) 합계 사용
    - X축 레이블은 두 시계열의 유니온(없는 버킷은 0 처리)
  - 전역 필터: 기간/상품 검색에 따라 툴팁 내 시계열도 동일하게 제한

- 예약 기반 분석
  - 예약 상태 전체 분포/교차 집계 바
    - 데이터: user_inquiry의 ‘예약 상태’(현재 실데이터에는 없음 → 스키마 보완 필요)
    - 교차 집계: (예약 상태 × 문의 유형 id=41988618714009), (예약 상태 × 언어 locale)
  - 예약코드별 문의 수 막대
    - 데이터: user_inquiry.custom_fields[id=41989351980441] (예약코드)별 건수 집계
  - 상품별 예약 상태 분포(옵션)
    - 데이터: user_inquiry.product_code × 예약 상태 집계 (실데이터 보완 시)
  - 전역 필터: 기간/상품 검색으로 동일하게 제한

- 예약 대비 문의 비율 카드(“상품 별 주문 대비 문의 비율”)
  - 데이터: 상품별 (문의 합계) / (주문 수량 합계)
    - 문의 합계: user_inquiry(해당 product_code)
    - 주문 수량 합계: product_order.reserve.order_number 합계 (단순 주문 건수 아님)
  - 전역 필터: 기간/상품 검색을 반영하여 대상 범위를 제한
  - 정렬 선택: ‘문의 많은 순’/‘문의 적은 순’ (기본: ‘문의 많은 순’) — 정렬 기준은 문의 합계(기본) 또는 비율(설정 가능)

### 백엔드
- 데이터 소스 및 ETL
  - user_inquiry: id, ticket_summary, created_at, custom_fields[{id,value}] 수집
  - product_order: reserve.code, reserve.created_at, reserve.order_number, custom_fields[{id,value}] 수집
  - spot_translation: spot_code→spot_name(ko) 조인용 캐시(고속 조회)
  - 예약 상태 값은 현재 소스에 없음 → 원천 시스템 협의로 스키마 보완 또는 파생 로직 정의 필요
- 정규화/파생 로직
  - product_code: id=41989966629273의 문자열에서 숫자 추출 후 마지막 5자리 유지
  - 상품 명: 같은 custom field의 스팟 코드로 spot_translation(language=ko) 매핑
  - locale 정규화: 언어코드 패턴 검증 및 표준화(ko, en, zh-HK 등)
- 집계 API/파이프라인
  - 트렌드: 기간/단위별 문의 수 집계 (일/월/분기/반기/연)
  - 상품×차원(문의 유형/언어) 교차 집계 및 총합
  - 주문 총합 및 상품별 일자 집계(주문 일시→날짜 절삭). 수량(order_number) 누적집계 고려(현 더미는 건수 기준)
  - 예약 상태/예약코드 집계 (상태 데이터 수집 가능 시)
  - 각 API는 CSV/정적 JSON 생성 또는 REST 응답 형태 선택 가능
  - 모든 엔드포인트는 전역 필터 파라미터 지원: `date_from`, `date_to`, `product_search`(상품명/코드 부분일치)
    - product_search는 product_code/spot_name(ko) 모두 검색 가능해야 함
  - 추가 집계(예약 기반 보조 카드)
    - 상품 별 주문 대비 문의 비율: product_code별 Σ(문의 수) / Σ(주문 수량) 계산 및 내림차순/오름차순 정렬 지원
    - 언어별 문의 유형 분포: locale별 {문의 유형 → 건수} 매핑과 Top N 계산(비율 포함) 제공
    - 예약코드별 문의 수: custom_fields[id=41989351980441] 값별 건수 집계 및 내림차순 정렬 지원
  - 테이블/리스트 API(선택)
    - 최근 문의 목록: id, created_at, product_code, spot_name(ko), locale, 문의 유형, ticket_summary, 예약코드 반환
    - 페이지네이션/검색/정렬 파라미터 지원(`page`, `page_size`, `query`, `sort`)
- 성능/캐싱
  - 일자 레인지·단위 조합 캐시(메모리/Redis)
  - spot_translation 매핑 캐시(버전 갱신 시 무효화)
  - 보조 카드 집계(비율/TopN/예약코드별)는 전역 필터 파라미터로 캐시 키 분리
- 품질/유효성 검증
  - 누락 필드/부정 값 검출 및 로깅
  - product_code 파싱 실패 케이스 보고 및 룰 보완
  - 주문/문의 소스 간 동기화 시차에 대한 명시(예: D-1 마감)

---

## 향후 확장 제안
- 상단 기간/정렬/검색 UI의 실제 필터링 기능 연결(프론트 필터 vs. 서버 사이드 쿼리 옵션)
- 상품 툴팁에 상세 샘플(최근 문의 텍스트/요청 ID, 최근 주문 ID) 탭 추가
- 예약 상태 수집 완료 시 예약 기반 탭 고도화(상태 정의/전환 퍼널 시각화)
- 다국어 지원(i18n) 및 타임존 고려(UTC vs. 로컬)
- 사용자 행동 이벤트(차원 전환/툴팁 열기/탭 전환) 로깅 기반의 사용성 분석
